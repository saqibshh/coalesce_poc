fileVersion: 1
id: "17"
isDisabled: false
metadata:
  defaultStorageLocation: null
  error: null
  nodeMetadataSpec: |
    capitalized: DYNAMIC STAGE FROM EXTERNAL
    short: 'DYN STAGE'
    tagColor: '#e74c3c'
    isDisabled: false
    plural: Dynamic Stages from External

    deployStrategy: advanced
    isColumnResyncEnabled: true

    config:
    - groupName: General Options
      items:
     
      - type: materializationSelector
        default: table
        options:
        - table
        - transient table
        isRequired: true 
      
      - displayName: Truncate Before Load
        attributeName: truncateBefore
        type: toggleButton
        default: true
        isRequired: false

      - type: label
        attributeName: note1
        displayName: 
                       "NOTE:
                       \n
                       This node creates a dynamic stage table from external table
                       with schema inference based on filtered date data"

    - groupName: Source Configuration
      items:

      - displayName: Variant Column Name
        attributeName: variantColumnName
        type: textBox
        default: 'VALUE'
        isRequired: true
        helpText: 'Name of the VARIANT column containing the data'

      - displayName: Date Filter Column
        attributeName: dateFilterColumn
        type: textBox
        default: 'METADATA$FILENAME'
        isRequired: true
        helpText: 'Column to use for date filtering (e.g., METADATA$FILENAME)'

      - displayName: Date Pattern
        attributeName: datePattern
        type: textBox
        default: '%/YYYY/MM/DD%'
        isRequired: true
        helpText: 'Date pattern in the filter column (e.g., %/2025/01/09%)'

    - groupName: Variable Table Configuration
      items:

      - displayName: Variable Table Name
        attributeName: variableTableName
        type: textBox
        default: 'CONTROL.VARIABLES'
        isRequired: true
        helpText: 'Fully qualified name of the variable/control table'

      - displayName: Date Variable Name
        attributeName: dateVariableName
        type: textBox
        default: 'PROCESS_DATE'
        isRequired: true
        helpText: 'Name of the date variable in the control table'

      - displayName: Variable Name Column
        attributeName: variableNameColumn
        type: textBox
        default: 'VARIABLE_NAME'
        isRequired: true
        helpText: 'Column name that contains variable names'

      - displayName: Variable Value Column
        attributeName: variableValueColumn
        type: textBox
        default: 'VARIABLE_VALUE'
        isRequired: true
        helpText: 'Column name that contains variable values'

    - groupName: Schema Inference Options
      items:

      - displayName: Sample Size for Schema Inference
        attributeName: sampleSize
        type: textBox
        default: "1000"
        isRequired: false
        helpText: 'Number of rows to sample for schema inference'

      - displayName: Infer Data Types
        attributeName: inferDataTypes
        type: toggleButton
        default: true
        isRequired: false
        helpText: 'Automatically infer data types from sample data'

      - displayName: Default String Length
        attributeName: defaultStringLength
        type: textBox
        default: "16777216"
        isRequired: false
        enableIf: "{% if config.inferDataTypes == false %} true {% else %} false {% endif %}"
        helpText: 'Default length for STRING columns when not inferring types'

      - displayName: Handle Nested Objects
        attributeName: handleNestedObjects
        type: dropdownSelector
        default: "FLATTEN"
        options:
        - "FLATTEN"
        - "KEEP_AS_VARIANT"
        - "JSON_STRING"
        isRequired: false
        helpText: 'How to handle nested objects and arrays'

      - displayName: Column Naming Convention
        attributeName: columnNaming
        type: dropdownSelector
        default: "SNAKE_CASE"
        options:
        - "SNAKE_CASE"
        - "CAMEL_CASE"
        - "UPPER_CASE"
        - "LOWER_CASE"
        - "ORIGINAL"
        isRequired: false
        helpText: 'Naming convention for column names'

      - displayName: Column Name Prefix
        attributeName: columnPrefix
        type: textBox
        default: ""
        isRequired: false
        helpText: 'Prefix to add to all column names'

    - groupName: Performance Options
      items:

      - displayName: Enable Parallel Processing
        attributeName: enableParallel
        type: toggleButton
        default: true
        isRequired: false
        helpText: 'Enable parallel processing for large datasets'

      - displayName: Batch Size
        attributeName: batchSize
        type: textBox
        default: "50000"
        isRequired: false
        helpText: 'Number of rows to process in each batch'

      - displayName: Create Indexes
        attributeName: createIndexes
        type: toggleButton
        default: false
        isRequired: false
        helpText: 'Create indexes on inferred date/timestamp columns'
        
    systemColumns:

    - displayName: LOAD_TIMESTAMP
      transform: 'current_timestamp()::timestamp_ntz'
      dataType: TIMESTAMP_NTZ
      placement: end
      attributeName: sysLoadTs

    - displayName: SOURCE_FILENAME
      transform: 'METADATA$FILENAME'
      dataType: STRING
      placement: end
      attributeName: sysSourceFilename

    - displayName: SOURCE_ROW_NUMBER
      transform: 'METADATA$FILE_ROW_NUMBER'
      dataType: NUMBER
      placement: end
      attributeName: sysSourceRowNumber

    - displayName: PROCESS_DATE
      transform: 'CURRENT_DATE()'
      dataType: DATE
      placement: end
      attributeName: sysProcessDate

name: DynamicStageFromExternal
type: NodeType
