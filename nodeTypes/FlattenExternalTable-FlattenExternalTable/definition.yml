fileVersion: 1
id: "15"
isDisabled: false
metadata:
  defaultStorageLocation: null
  error: null
  nodeMetadataSpec: |
    capitalized: FLATTEN VARIANT TO COLUMNS
    short: 'FLATTEN VAR'
    tagColor: '#4a90e2'
    isDisabled: false
    plural: Flatten Variant to Columns

    deployStrategy: advanced
    isColumnResyncEnabled: true

    config:
    - groupName: General Options
      items:
     
      - type: materializationSelector
        default: table
        options:
        - table
        - transient table
        - view
        isRequired: true 
      
      - displayName: Truncate Before Load
        attributeName: truncateBefore
        type: toggleButton
        default: false
        enableIf: "{%if config.materializationType == 'view' %} false {%else%} true {%endif%}"

    - groupName: Source Configuration
      items:
      
      - type: label
        attributeName: note1
        displayName: 
                       "NOTE:
                       \n
                       This node flattens VARIANT fields from external tables
                       into proper columns with inferred data types"
      
      - displayName: Source External Table
        attributeName: sourceExternalTable
        type: textBox
        default: 'Enter fully qualified external table name (database.schema.table)'
        isRequired: true

      - displayName: Variant Column Name
        attributeName: variantColumnName
        type: textBox
        default: 'SRC'
        isRequired: true
        helpText: 'Name of the VARIANT column to flatten'

      - displayName: Flatten Path
        attributeName: flattenPath
        type: textBox
        default: '$'
        isRequired: false
        helpText: 'JSON path to start flattening from (default: $ for root)'

      - displayName: Recursive Flattening
        attributeName: recursiveFlatten
        type: toggleButton
        default: true
        isRequired: false
        helpText: 'Enable recursive flattening of nested structures'

      - displayName: Flatten Mode
        attributeName: flattenMode
        type: dropdownSelector
        default: "OBJECT"
        options:
        - "OBJECT"
        - "ARRAY"
        - "BOTH"
        isRequired: false
        helpText: 'Flattening mode for handling objects and arrays'

    - groupName: Schema Inference
      items:

      - displayName: Sample Size for Schema Inference
        attributeName: sampleSize
        type: textBox
        default: "1000"
        isRequired: false
        helpText: 'Number of rows to sample for schema inference'

      - displayName: Infer Data Types
        attributeName: inferDataTypes
        type: toggleButton
        default: true
        isRequired: false
        helpText: 'Automatically infer data types from sample data'

      - displayName: Default String Length
        attributeName: defaultStringLength
        type: textBox
        default: "16777216"
        isRequired: false
        enableIf: "{% if config.inferDataTypes == false %} true {% else %} false {% endif %}"
        helpText: 'Default length for STRING columns when not inferring types'

      - displayName: Handle Null Values
        attributeName: handleNullValues
        type: dropdownSelector
        default: "KEEP"
        options:
        - "KEEP"
        - "EXCLUDE"
        - "DEFAULT"
        isRequired: false
        helpText: 'How to handle null values in flattened data'

      - displayName: Null Default Value
        attributeName: nullDefaultValue
        type: textBox
        default: "NULL"
        isRequired: false
        enableIf: "{% if config.handleNullValues == 'DEFAULT' %} true {% else %} false {% endif %}"
        helpText: 'Default value to use for null values'

    - groupName: Column Naming
      items:

      - displayName: Column Naming Convention
        attributeName: columnNaming
        type: dropdownSelector
        default: "SNAKE_CASE"
        options:
        - "SNAKE_CASE"
        - "CAMEL_CASE"
        - "UPPER_CASE"
        - "LOWER_CASE"
        - "ORIGINAL"
        isRequired: false
        helpText: 'Naming convention for flattened column names'

      - displayName: Column Name Prefix
        attributeName: columnPrefix
        type: textBox
        default: ""
        isRequired: false
        helpText: 'Prefix to add to all column names'

      - displayName: Column Name Suffix
        attributeName: columnSuffix
        type: textBox
        default: ""
        isRequired: false
        helpText: 'Suffix to add to all column names'

    - groupName: Performance
      items:

      - displayName: Enable Parallel Processing
        attributeName: enableParallel
        type: toggleButton
        default: true
        isRequired: false
        helpText: 'Enable parallel processing for large datasets'

      - displayName: Batch Size
        attributeName: batchSize
        type: textBox
        default: "10000"
        isRequired: false
        helpText: 'Number of rows to process in each batch'
        
    systemColumns:

    - displayName: FLATTEN_TIMESTAMP
      transform: 'current_timestamp()::timestamp_ntz'
      dataType: TIMESTAMP_NTZ
      placement: end
      attributeName: sysFlattenTs

    - displayName: SOURCE_ROW_ID
      transform: 'metadata$file_row_number'
      dataType: NUMBER
      placement: end
      attributeName: sysSourceRowId

    - displayName: FLATTEN_PATH
      transform: 'path'
      dataType: STRING
      placement: end
      attributeName: sysFlattenPath

    - displayName: INDEX
      transform: 'index'
      dataType: NUMBER
      placement: end
      attributeName: sysIndex

    - displayName: KEY
      transform: 'key'
      dataType: STRING
      placement: end
      attributeName: sysKey

    - displayName: VALUE
      transform: 'value'
      dataType: VARIANT
      placement: end
      attributeName: sysValue

    - displayName: THIS
      transform: 'this'
      dataType: VARIANT
      placement: end
      attributeName: sysThis

name: FlattenExternalTable
type: NodeType
