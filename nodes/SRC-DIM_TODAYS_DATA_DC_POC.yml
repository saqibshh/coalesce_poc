fileVersion: 1
id: 26acf2e7-b701-489c-8b5e-de65a7398185
name: DIM_TODAYS_DATA_DC_POC
operation:
  config:
    postSQL: |-
      -- SCD Type 2: Insert new and changed records into DC_POC
      INSERT INTO {{ ref('SRC', 'DC_POC') }} (id, name, active, created_at, updated_at)
      SELECT 
        t.id,
        t.name,
        TRUE as active,
        CURRENT_TIMESTAMP() as created_at,
        CURRENT_TIMESTAMP() as updated_at
      FROM {{ ref('SRC', 'V_TODAYS_DATA') }} t
      FULL OUTER JOIN {{ ref('SRC', 'DC_POC') }} d 
        ON t.id = d.id AND d.active = TRUE
      WHERE d.id IS NULL  -- New records (empty table â†’ all records inserted)
         OR (t.name != d.name OR t.name IS NULL != d.name IS NULL);  -- Changed records
    preSQL: |-
      -- Step 1: Mark existing records as inactive (only if table has data)
      UPDATE {{ ref('SRC', 'DC_POC') }} 
      SET active = FALSE, 
          updated_at = CURRENT_TIMESTAMP()
      WHERE EXISTS (
        SELECT 1 FROM {{ ref('SRC', 'V_TODAYS_DATA') }} t
        WHERE t.id = {{ ref('SRC', 'DC_POC') }}.id
        AND {{ ref('SRC', 'DC_POC') }}.active = TRUE
        AND (t.name != {{ ref('SRC', 'DC_POC') }}.name OR t.name IS NULL != {{ ref('SRC', 'DC_POC') }}.name IS NULL)
      );
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: SCD Type 2 Dimension that processes changes from TODAYS_DATA and updates DC_POC accordingly
  isMultisource: false
  locationName: SRC
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 322db389-04ce-4601-a833-fea2cf7d5c3c
          stepCounter: 26acf2e7-b701-489c-8b5e-de65a7398185
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        isBusinessKey: true
        name: ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 469f4596-8d2b-419c-bf0f-f52dfbea41b5
                stepCounter: b9d1ebac-2cda-47f1-9810-bda9592ad0c6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0319e3d6-e9ec-4e98-9caf-1719b23e2986
          stepCounter: 26acf2e7-b701-489c-8b5e-de65a7398185
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        isChangeTracking: true
        name: NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 324777f7-b64f-4b64-adb1-b2f292108cfa
                stepCounter: b9d1ebac-2cda-47f1-9810-bda9592ad0c6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: de4c0299-e286-4946-a2e6-55d7d7596fcf
          stepCounter: 26acf2e7-b701-489c-8b5e-de65a7398185
        config: {}
        dataType: BOOLEAN
        description: ""
        isChangeTracking: true
        isSystemCurrentFlag: true
        name: ACTIVE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: "TRUE"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 64f38ac1-c9c0-417c-b290-ebe871aac766
          stepCounter: 26acf2e7-b701-489c-8b5e-de65a7398185
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        description: ""
        isChangeTracking: true
        isSystemStartDate: true
        name: CREATED_AT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: CURRENT_TIMESTAMP()
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 654ed108-b265-47d4-b324-8806f3a3dd01
          stepCounter: 26acf2e7-b701-489c-8b5e-de65a7398185
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        description: ""
        isChangeTracking: true
        isSystemUpdateDate: true
        name: UPDATED_AT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: CURRENT_TIMESTAMP()
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          V_DC_POC: 1ed7700b-fa23-47ff-aad0-2ecf93f42fca
          V_TODAYS_DATA: b9d1ebac-2cda-47f1-9810-bda9592ad0c6
        customSQL:
          customSQL: |-
            -- Debug: Show what data is available from V_TODAYS_DATA
            SELECT 
              id,
              name,
              TRUE as active,
              CURRENT_TIMESTAMP() as created_at,
              CURRENT_TIMESTAMP() as updated_at,
              'DEBUG: Records from V_TODAYS_DATA' as debug_info
            FROM {{ ref('SRC', 'V_TODAYS_DATA') }}
        dependencies:
          - locationName: SRC
            nodeName: V_DC_POC
          - locationName: SRC
            nodeName: V_TODAYS_DATA
        join:
          joinCondition: FROM {{ ref('SRC', 'V_TODAYS_DATA') }} "V_TODAYS_DATA"
        name: DIM_TODAYS_DATA_DC_POC
        noLinkRefs: []
  name: DIM_TODAYS_DATA_DC_POC
  overrideSQL: false
  schema: ""
  sqlType: Dimension
  type: sql
  version: 1
type: Node
